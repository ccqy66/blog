---
title: CSRF攻击理解及防御
date: 2018-02-12 17:36:04
tags:
- 安全
- CRSF
categories: 安全
---

#### 什么是CSRF
CSRF（Cross Site Request Forgery, 跨站域请求伪造）是一种网络的攻击方式，该攻击可以在受害者毫不知情的情况下以受害者名义伪造请求发送给受攻击站点，从而在并未授权的情况下执行在权限保护之下的操作，有很大的危害性。，它在 2007 年曾被列为互联网 20 大安全隐患之一。其他安全隐患，比如 SQL 脚本注入，跨站域脚本攻击等在近年来已经逐渐为众人熟知，很多网站也都针对他们进行了防御。
<!--more-->
#### CSRF攻击原理
{% asset_img CSRF.png %}
根据上图我们分析CSRF的攻击过程：
- 首先黑客开发应用B。
- 用户输入用户名和密码登录的一个提供服务的应用网站A。
- 应用网站A成功校验用户提交用户名和密码，并生成cookie。
- 此时，黑客通过某种方式触发用户访问了黑客提前预设的网站B。
- 网站B，触发一个请求A的请求，但是该请求对用户而言并不知情。
- 按照黑客的意愿，使用用户的cookie请求了应用A。

从上述的说明，可能会感觉该攻击也不具有那么大的杀伤力，那么我们来分析一个例子。
>假设应用A是某银行的网上营业厅，提供转账功能。黑客通过分析抓取到了转账的api为：http://www.bank.com/transfer?from=user1&to=user2&count=1000
其中，from为转账方，to为收账方，count为转账金额。（真实的转账接口当然不会这么简单，这里仅仅是一个例子）

案例：
- 用户（银行账号user1）首先正常的输入账号密码登录了网上营业厅，并拿到了该网站返回的cookie。
- 此时，黑客（银行账号user2）通过某种技术手段，让用户访问了自己提前预设的网站：http://www.hack.com 该网站将重定向到银行的转账服务：
http://www.bank.com/transfer?from=user1&to=user2&count=1000
- 该请求对银行还说就认为user1将要给user2转账1000元，因为是在用户user1所处的浏览器上请求的，所以解析到cookie正是user1的，通过校验，执行转账。用户user1的1000元钱转给了user2.

#### 防御策略

从上述的分析我们知道，黑客之所以可以利用CSRF攻击到用户，本质原因是
> 1.攻击者可以获取到资源操作的URL。假如攻击者不知道操作的URL，也就无法构造操作的连接。
> 2.使用了隐式的身份验证机制。

虽然我们知道，防御CSRF解决如上两个问题即可，但是对于问题1，在实际解决时是很难解决的，暂时还没有什么有效的办法可以避免我们的接口不被第三方知晓的。既然如此就需要从身份验证机制上找解决之道了。
现如今比较有效的处理方案有如下几个：
- 验证码机制：
CSRF攻击往往是在用户不知情的情况下请求的，为了打破这个条件，可以在请求之前增加一种交互方式，要求用户输入验证码：该行为告知用户，你需要请求一个重要的请求，如果是你主动请求的，那么请你输入验证码；如果不是那么用户也就忽略了该行为了。
- Referer检查：
CSRF攻击的请求发送源一般不会本站发出的，而是由第三方网站构造出的请求发出的，所以可以在服务端做一次校验，校验请求头的Referer参数是否为本站，如果是本站，则验证通过，否则阻挡请求。但是这种方式存在问题：
 - 用户可以通过设置，禁用Referer功能，服务端就可能拿不到Referer，这样就导致一个正常的请求被阻挡了。
 - 当攻击者将恶意构造的请求嵌入本站的某个页面，此时请求的Referer也是本站，但是该请求也属于CSRF攻击的范畴，问题并未解决。
- token验证：
在需要防御CSRF的页面中加入一个隐藏字段-token，在页面渲染之时，就拿到了服务端颁发的唯一token，在表单提交的时候会带上该token，服务端在处理请求时，会首先解析请求中带有的token字段，只有token检验通过才会进行其他的操作。CSRF攻击时是没有办法拿到合法的token的，就算构造恶意请求，也是无法被执行的。
